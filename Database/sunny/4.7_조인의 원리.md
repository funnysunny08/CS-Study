# 조인 수행 원리

조인의 수행 원리

- 중첩 루프 조인
- 정렬 병합 조인
- 해시 조인

## 중첩 루프 조인 (NLJ, Nested Loop Join)

**중첩 for문과 같은 원리**로 조건에 맞는 조인을 하는 방법!!

반복문의 외부에 있는 테이블을 👉 선행 테이블 또는 외부 테이블(Outer Table)

반복문의 내부에 있는 테이블을 👉 후행 테이블 또는 내부 테이블(Inner Table)

*💡 선행 테이블의 조건을 만족하는 행을 추출하여 후행 테이블을 읽으면서 조인을 수행한다!*

- 결과 행의 수가 적은 테이블을 조인 순서 상 선행 테이블로 선택하는 것이 전체 일량을 줄일 수 있다!
- 랜덤 방식으로 데이터를 액세스한다.
- 선행 테이블에 사용 가능한 인덱스가 존재한다면 인덱스를 통해 선행 테이블을 액세스할 수 있다.

> **NLJ 동작 원리**
> 
> 
> ![image](https://github.com/funnysunny08/coding-test-java/assets/88873302/e3d7039b-c8a8-430d-bedf-18825bf87daa)
> 
> 1. 선행 테이블에서 조건을 만족하는 첫 번째 행을 찾음
> 2. 선행 테이블의 조인 키를 가지고 후행 테이블에 조인 키가 존재하는지 찾음
> 3. 후행 테이블의 인덱스에 선행 테이블의 조인 키가 존재하는지 확인
> 4. 인덱스에서 추출한 레코드 식별자를 이용하는 후행 테이블을 액세스
>
> 5~11. 앞의 작업을 반복 수행
> 

## 정렬 병합 조인 (SMJ, Sorted Merge Join)

조인 칼럼을 기준으로 데이터를 정렬하여 조인을 수행하는 방법!!

- Sort Merge Join은 NLJ와는 달리 스캔 방식을 사용한다.
- 정렬할 데이터가 많은 경우 임시 영역(디스크)을 사용하기 때문에 성능이 떨어질 수도 있음
- 수행 도중 정렬 작업이 미리 수행되었다면 조인을 위한 정렬작업이 발생되지 않을 수도 있음

> **SMJ 동작 원리**
> 
> 
> ![image](https://github.com/funnysunny08/coding-test-java/assets/88873302/c5befdb2-85fc-4a6d-88aa-fc70b84abd8c)
> 
> 1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
> 
> 2. 선행 테이블의 조인 키를 기준으로 정렬 작업을 수행
> 
> 1~2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
> 
> 3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음
> 
> 4. 후행 테이블의 조인 키를 기준으로 정렬 작업을 수행
> 
> 3~4번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
> 
> 5. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출버퍼에 넣음
> 

## 해시 조인 (Hash Join)

Hash Join은 해시 테이블을 기반으로 조인하는 방법!!

💡 조인을 수행할 테이블의 조인 칼럼을 기준으로 해쉬 함수를 수행하여 서로 동일한 해쉬 값을 갖는 것들 사이에서 실제 값이 같은지를 비교하면서 조인을 수행한다!!

- 두 개의 테이블을 조인한다고 했을 때 하나의 테이블이 메모리에 온전히 들어간다면 보통 중첩 루프 조인보다 더 효율적이다!
    - 메모리에 올릴 수 없을 정도로 크다면 디스크를 사용하는 비용이 발생된다!
- 동등(=) 조인에서만 사용할 수 있다.
- 해쉬 테이블을 메모리에 생성해야하고, 크기가 클 경우 임시 영역에 저장하기 때문에 결과 행의 수가 적은 테이블을 선행 테이블로 사용하는 것이 좋음
- 먼저 해쉬 테이블을 생성하는 선행 테이블(Build Input), 해쉬 테이블에 대해 해쉬 값의 존재 여부를 검사하는후행 테이블(Prove Input)로 이루어짐

> **Hash Join의 동작 원리**
> 
> 
> ![image](https://github.com/funnysunny08/coding-test-java/assets/88873302/55b92bea-d6d5-4432-81b4-92af6ce94e58)
> 
> 1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
> 
> 2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블을 생성
> 
> (조인 칼럼과 SELECT 절에서 필요로 하는 칼럼도 함께 저장됨)
> 
> 1~2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
> 
> 3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음
> 
> 4. 후행 테이블의 조인키를 기준으로 해쉬 함수를 적용하여 해당 버킷을 찾음
> 
> (조인 키를 이용해서 실제 조인될 데이털르 찾음)
> 
> 5. 조인에 성공하면 추출버퍼에 넣음
> 
> 3~5번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해서 반복 수행
> 

---

### 📚 참고 자료

- https://eehoeskrap.tistory.com/84